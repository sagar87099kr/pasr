<% layout('./layoutes/boilerplate.ejs') -%>
    <link rel="stylesheet" href="/css/product_detail.css">
    <% const SHOP_CATEGORIES={ "Electronics" : [ { name: "Wiring & Cables" , icon: "ðŸ”Œ" }, {
        name: "Switches & Switchgear" , icon: "ðŸŽšï¸" }, { name: "Distribution Panels" , icon: "âš¡" }, { name: "Lighting" ,
        icon: "ðŸ’¡" }, { name: "Fans" , icon: "ðŸ’¨" }, { name: "Installation Material" , icon: "ðŸ› ï¸" }, {
        name: "Sockets & Plugs" , icon: "ðŸ”Œ" }, { name: "Inverters & Batteries" , icon: "ðŸ”‹" }, { name: "Pumps & Motors"
        , icon: "ðŸŒŠ" }, { name: "Tools & Testing" , icon: "ðŸ§°" }, { name: "Smart & Security" , icon: "ðŸ”’" }, {
        name: "General" , icon: "ðŸ“¦" } ], "Grocery" : [ { name: "Staples & Grains" , icon: "ðŸŒ¾" }, {
        name: "Edible Oil & Ghee" , icon: "ðŸ›¢ï¸" }, { name: "Spices & Masala" , icon: "ðŸŒ¶ï¸" }, { name: "Snacks & Namkeen"
        , icon: "ðŸ¥¨" }, { name: "Beverages" , icon: "ðŸ¥¤" }, { name: "Dairy & Refrigerator" , icon: "ðŸ¥›" }, {
        name: "Bakery Items" , icon: "ðŸž" }, { name: "Personal Care" , icon: "ðŸ§´" }, { name: "Home Cleaning & Household"
        , icon: "ðŸ§¹" }, { name: "Baby Care" , icon: "ðŸ‘¶" }, { name: "Dry Fruits & Sweets" , icon: "ðŸ¥œ" }, {
        name: "Instant & Ready to Eat" , icon: "ðŸœ" }, { name: "General" , icon: "ðŸ“¦" } ], "Fashion" : [ {
        name: "Men's Wear" , icon: "ðŸ‘•" }, { name: "Women's Wear" , icon: "ðŸ‘—" }, { name: "Kids Wear" , icon: "ðŸ‘¶" }, {
        name: "Ethnic Wear" , icon: "ðŸ‘˜" }, { name: "Winter Wear" , icon: "ðŸ§¥" }, { name: "Sports & Activewear" ,
        icon: "ðŸƒ" }, { name: "Innerwear & Lingerie" , icon: "ðŸ©²" }, { name: "Accessories" , icon: "ðŸ‘œ" }, {
        name: "General" , icon: "ðŸ“¦" } ], "General Store" : [ { name: "Daily Essentials" , icon: "ðŸ§¼" }, {
        name: "Snacks & Beverages" , icon: "ðŸ¥¤" }, { name: "Personal Care" , icon: "ðŸ§´" }, { name: "Household Items" ,
        icon: "ðŸ " }, { name: "Stationery" , icon: "âœï¸" }, { name: "Cleaning Supplies" , icon: "ðŸ§¹" }, {
        name: "Baby Care" , icon: "ðŸ‘¶" }, { name: "General" , icon: "ðŸ“¦" } ], "Footwear" : [ { name: "Men's Footwear" ,
        icon: "ðŸ‘ž" }, { name: "Women's Footwear" , icon: "ðŸ‘ " }, { name: "Kids' Footwear" , icon: "ðŸ‘Ÿ" }, {
        name: "Sports & Active Footwear" , icon: "ðŸƒ" }, { name: "Seasonal Footwear" , icon: "ðŸ‘¢" }, {
        name: "Premium / Branded" , icon: "ðŸ·ï¸" }, { name: "Footwear Accessories" , icon: "ðŸ§¦" }, { name: "General" ,
        icon: "ðŸ“¦" } ], "Automobile" : [ { name: "Parts & Accessories" , icon: "ðŸ”§" }, { name: "Oils & Lubricants" ,
        icon: "ðŸ›¢ï¸" }, { name: "Batteries" , icon: "ðŸ”‹" }, { name: "Tires & Wheels" , icon: "âš™ï¸" }, {
        name: "Car Care & Cleaning" , icon: "âœ¨" }, { name: "Tools & Equipment" , icon: "ðŸ§°" }, { name: "General" ,
        icon: "ðŸ“¦" } ], "Bakery" : [ { name: "Breads" , icon: "ðŸž" }, { name: "Cakes & Pastries" , icon: "ðŸŽ‚" }, {
        name: "Cookies & Biscuits" , icon: "ðŸª" }, { name: "Sweets & Desserts" , icon: "ðŸ°" }, { name: "Savory Items" ,
        icon: "ðŸ¥" }, { name: "Custom Orders" , icon: "ðŸ“" }, { name: "General" , icon: "ðŸ“¦" } ], "Dhaba" : [ {
        name: "Veg Dishes" , icon: "ðŸ¥—" }, { name: "Non-Veg Dishes" , icon: "ðŸ—" }, { name: "Rice & Roti" , icon: "ðŸš"
        }, { name: "Snacks & Starters" , icon: "ðŸŸ" }, { name: "Beverages" , icon: "ðŸ¥¤" }, { name: "Combo Meals" ,
        icon: "ðŸ±" }, { name: "General" , icon: "ðŸ“¦" } ], "Furniture" : [ { name: "Beds & Mattresses" , icon: "ðŸ›ï¸" }, {
        name: "Sofas & Chairs" , icon: "ðŸ›‹ï¸" }, { name: "Tables & Desks" , icon: "ðŸª‘" }, { name: "Storage & Cabinets" ,
        icon: "ðŸ—„ï¸" }, { name: "Home Decor" , icon: "ðŸ–¼ï¸" }, { name: "Office Furniture" , icon: "ðŸ’¼" }, {
        name: "General" , icon: "ðŸ“¦" } ], "Hardware" : [ { name: "Tools & Equipment" , icon: "ðŸ”¨" }, {
        name: "Building Materials" , icon: "ðŸ§±" }, { name: "Paint & Supplies" , icon: "ðŸŽ¨" }, { name: "Plumbing" ,
        icon: "ðŸš°" }, { name: "Electrical Items" , icon: "ðŸ’¡" }, { name: "Locks & Security" , icon: "ðŸ”’" }, {
        name: "General" , icon: "ðŸ“¦" } ], "Jewelers" : [ { name: "Gold Jewelry" , icon: "ðŸ’›" }, { name: "Silver Jewelry"
        , icon: "ðŸ¤" }, { name: "Diamond Jewelry" , icon: "ðŸ’Ž" }, { name: "Imitation / Fashion" , icon: "âœ¨" }, {
        name: "Bridal Jewelry" , icon: "ðŸ‘°" }, { name: "Repairs & Custom" , icon: "ðŸ”§" }, { name: "General" , icon: "ðŸ“¦"
        } ], "Medical" : [ { name: "Medicines" , icon: "ðŸ’Š" }, { name: "Health Supplements" , icon: "ðŸ’ª" }, {
        name: "Medical Devices" , icon: "ðŸ©º" }, { name: "First Aid" , icon: "ðŸ©¹" }, { name: "Baby Care" , icon: "ðŸ‘¶" },
        { name: "Personal Care" , icon: "ðŸ§´" }, { name: "General" , icon: "ðŸ“¦" } ], "Mobile Shop" : [ {
        name: "Smartphones" , icon: "ðŸ“±" }, { name: "Feature Phones" , icon: "ðŸ“ž" }, { name: "Accessories" , icon: "ðŸŽ§"
        }, { name: "Chargers & Cables" , icon: "ðŸ”Œ" }, { name: "Cases & Covers" , icon: "ðŸ“²" }, {
        name: "Repairs & Services" , icon: "ðŸ”§" }, { name: "General" , icon: "ðŸ“¦" } ], "Non-Veg" : [ { name: "Chicken" ,
        icon: "ðŸ—" }, { name: "Mutton" , icon: "ðŸ–" }, { name: "Fish" , icon: "ðŸŸ" }, { name: "Eggs" , icon: "ðŸ¥š" }, {
        name: "Seafood" , icon: "ðŸ¦" }, { name: "Frozen Items" , icon: "â„ï¸" }, { name: "General" , icon: "ðŸ“¦" }
        ], "Printing & Digital" : [ { name: "Printing Services" , icon: "ðŸ–¨ï¸" }, { name: "Photocopying" , icon: "ðŸ“„" },
        { name: "Scanning" , icon: "ðŸ“·" }, { name: "Lamination" , icon: "ðŸ§¾" }, { name: "Binding" , icon: "ðŸ“š" }, {
        name: "Design Services" , icon: "ðŸŽ¨" }, { name: "General" , icon: "ðŸ“¦" } ], "Restaurant" : [ {
        name: "Veg Dishes" , icon: "ðŸ¥—" }, { name: "Non-Veg Dishes" , icon: "ðŸ—" }, { name: "Chinese" , icon: "ðŸ¥¡" }, {
        name: "South Indian" , icon: "ðŸ¥˜" }, { name: "Beverages" , icon: "ðŸ¥¤" }, { name: "Desserts" , icon: "ðŸ¨" }, {
        name: "General" , icon: "ðŸ“¦" } ], "Salon" : [ { name: "Haircut & Styling" , icon: "âœ‚ï¸" }, { name: "Hair Color" ,
        icon: "ðŸŽ¨" }, { name: "Facial & Cleanup" , icon: "ðŸ’†" }, { name: "Spa & Massage" , icon: "ðŸ’…" }, {
        name: "Bridal Services" , icon: "ðŸ‘°" }, { name: "Men's Grooming" , icon: "ðŸ§”" }, { name: "General" , icon: "ðŸ“¦"
        } ], "Seeds & Fertilizers" : [ { name: "Seeds" , icon: "ðŸŒ±" }, { name: "Chemical Fertilizers" , icon: "ðŸ§ª" }, {
        name: "Organic Fertilizers" , icon: "â™»ï¸" }, { name: "Pesticides" , icon: "ðŸ¦Ÿ" }, { name: "Farming Tools" ,
        icon: "ðŸšœ" }, { name: "Plant Care" , icon: "ðŸŒ¿" }, { name: "General" , icon: "ðŸ“¦" } ], "Stationery" : [ {
        name: "Writing Supplies" , icon: "âœï¸" }, { name: "Notebooks & Diaries" , icon: "ðŸ““" }, { name: "Art & Craft" ,
        icon: "ðŸŽ¨" }, { name: "Office Supplies" , icon: "ðŸ“Ž" }, { name: "School Items" , icon: "ðŸŽ’" }, {
        name: "Printing Paper" , icon: "ðŸ“„" }, { name: "General" , icon: "ðŸ“¦" } ] }; function
        getShopCategoryData(shopCategory) { if (!shopCategory) return null; const
        key=Object.keys(SHOP_CATEGORIES).find(function(k) { return k.toLowerCase()===shopCategory.toLowerCase(); });
        return key ? SHOP_CATEGORIES[key] : null; } const currentShopCats=getShopCategoryData(shop.category); %>
        <style>
            /* Review styles */
            .reviews-card {
                background: #fff;
                border-radius: 16px;
                padding: 24px;
                border: 1px solid #e5e7eb;
                margin-top: 24px;
            }

            .review-form .field {
                margin-bottom: 16px;
            }

            .review-form label {
                display: block;
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #4b5563;
            }

            .review-form textarea,
            .review-form select {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #d1d5db;
            }

            .review-card {
                padding: 16px;
                border-bottom: 1px solid #f3f4f6;
                margin-bottom: 16px;
            }

            .review-top {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .review-user {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .avatar {
                width: 40px;
                height: 40px;
                background: #e0e7ff;
                color: #3b82f6;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                font-weight: bold;
            }

            .user-name {
                font-weight: 700;
                font-size: 14px;
            }

            .user-sub {
                font-size: 12px;
                color: #9ca3af;
            }

            .rating {
                color: #f59e0b;
            }

            .review-comment {
                color: #4b5563;
                line-height: 1.5;
            }

            /* Item Modal & Grid Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgb(0, 0, 0);
                background-color: rgba(0, 0, 0, 0.4);
            }

            .modal-content {
                background-color: #fefefe;
                margin: 10% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 90%;
                max-width: 500px;
                border-radius: 12px;
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

            .items-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .item-card {
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 10px;
                background: #fff;
                transition: transform 0.2s;
            }

            .item-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .item-img {
                width: 100%;
                height: 150px;
                object-fit: cover;
                border-radius: 8px;
                margin-bottom: 10px;
            }

            .item-title {
                font-weight: 600;
                font-size: 16px;
                margin-bottom: 5px;
            }

            .item-price {
                color: #10b981;
                font-weight: 700;
            }

            .item-qty {
                color: #6b7280;
                font-size: 13px;
            }

            .btn-add-item {
                background-color: #3b82f6;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-weight: 600;
                margin-top: 20px;
            }

            .btn-add-item:hover {
                background-color: #2563eb;
            }


            /* Mobile Call Action */
            .mobile-call-action {
                display: none;
                margin-bottom: 20px;
            }

            @media (max-width: 900px) {
                .mobile-call-action {
                    display: block;
                }
            }

            /* Category Slider Base Styles */
            .cat-scroll-wrapper {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
                margin-bottom: 20px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .cat-scroll-wrapper::-webkit-scrollbar {
                display: none;
            }

            .cat-pill {
                display: inline-block;
                background: white;
                border: 1px solid #eee;
                padding: 8px 18px;
                border-radius: 20px;
                margin-right: 10px;
                color: #333;
                font-weight: 500;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                text-decoration: none;
                cursor: pointer;
                transition: all 0.2s;
            }

            .cat-pill:hover {
                background: #f8f9fa;
                color: #000080;
            }

            .cat-pill.active {
                background: #138808;
                color: white;
                border-color: #138808;
            }

            /* Market Style Product Card */
            .items-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 20px;
                margin-top: 10px;
            }

            /* Mobile Optimizations */
            @media (max-width: 600px) {
                .items-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 12px;
                }

                .product-img-wrap {
                    height: 140px;
                    /* Taller images */
                }

                .card-body-custom {
                    padding: 10px;
                }

                .prod-title {
                    font-size: 0.95rem;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }

                /* Fixed Slider Styles */
                .cat-scroll-wrapper {
                    margin: 0;
                    padding: 0 10px;
                    /* Start text with some spacing */
                    width: 100%;
                    max-width: 100vw;
                }

                .cat-scroll-wrapper-container {
                    margin: 0;
                    /* Reset negative margins */
                    padding: 0;
                    width: 100%;
                    position: sticky;
                    top: 60px;
                    z-index: 90;
                    background-color: var(--bg-color);
                }

                .items-grid {
                    padding: 0 8px;
                    /* Slight padding so cards don't touch screen edge */
                }
            }

            .product-card {
                background: white;
                border-radius: 16px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                /* shadow-sm */
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid #e5e7eb;
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .product-card:hover {
                transform: translateY(-6px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
                border-color: #ff9933;
                /* market-primary */
            }

            .product-img-wrap {
                position: relative;
                height: 160px;
                overflow: hidden;
                background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            }

            .product-img-wrap img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
            }

            .product-card:hover .product-img-wrap img {
                transform: scale(1.05);
            }

            .price-tag {
                position: absolute;
                top: 10px;
                right: 10px;
                background: linear-gradient(135deg, #ff9933, #ff7700);
                color: white;
                font-size: 0.9rem;
                font-weight: 700;
                padding: 6px 12px;
                border-radius: 20px;
                box-shadow: 0 4px 12px rgba(255, 153, 51, 0.4);
                display: flex;
                align-items: center;
                gap: 2px;
            }

            .card-body-custom {
                padding: 14px;
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .prod-title {
                font-size: 1rem;
                font-weight: 700;
                margin: 0;
                color: #1f2937;
                line-height: 1.3;
                text-transform: capitalize;
            }

            .prod-meta {
                margin-top: auto;
                padding-top: 10px;
                border-top: 1px solid #f0f0f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.8rem;
                color: #6b7280;
            }

            .item-action-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-top: 10px;
            }

            .item-delete-btn,
            .item-edit-btn {
                border: none;
                padding: 8px;
                border-radius: 6px;
                font-size: 0.85rem;
                cursor: pointer;
                transition: background 0.2s;
                width: 100%;
                font-weight: 500;
            }

            .item-delete-btn {
                background: #fee2e2;
                color: #ef4444;
            }

            .item-delete-btn:hover {
                background: #fecaca;
            }

            .item-edit-btn {
                background: #dbeafe;
                color: #2563eb;
            }

            .item-edit-btn:hover {
                background: #bfdbfe;
            }

            /* Override for Shop Profile Page (Single Column) */
            .shop-profile-container {
                grid-template-columns: 1fr !important;
            }

            /* NEW: Item Detail Modal */
            .item-modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.75);
                align-items: center;
                justify-content: center;
            }

            .item-modal-card {
                background: white;
                border-radius: 20px;
                width: 90%;
                max-width: 500px;
                max-height: 90vh;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                animation: modalSlideIn 0.3s ease-out;
                position: relative;
            }

            @keyframes modalSlideIn {
                from {
                    transform: scale(0.8);
                    opacity: 0;
                }

                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .item-modal-close {
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(0, 0, 0, 0.6);
                color: white;
                border: none;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                font-size: 20px;
                cursor: pointer;
                z-index: 10;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.2s;
            }

            .item-modal-close:hover {
                background: rgba(0, 0, 0, 0.9);
            }

            .item-modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 25px 20px;
                text-align: center;
                color: white;
            }

            .item-modal-title {
                margin: 0;
                font-size: 22px;
                font-weight: 700;
            }

            .item-modal-body {
                padding: 0;
                overflow-y: auto;
                max-height: calc(90vh - 150px);
            }

            .item-modal-img-wrapper {
                position: relative;
                width: 100%;
            }

            .item-modal-img {
                width: 100%;
                height: 500px;
                object-fit: cover;
                display: block;
            }

            .item-modal-price-overlay {
                position: absolute;
                bottom: 15px;
                right: 15px;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
                font-size: 24px;
                font-weight: 700;
                padding: 12px 20px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .item-modal-whatsapp-btn {
                display: block;
                width: 100%;
                background: #25D366;
                color: white;
                padding: 18px;
                border: none;
                border-radius: 0;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                text-decoration: none;
                text-align: center;
                transition: 0.3s;
            }

            .item-modal-whatsapp-btn:hover {
                background: #20ba5a;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
                color: white;
            }

            @media (max-width: 600px) {
                .item-modal-card {
                    width: 95%;
                }

                .item-modal-img {
                    height: 400px;
                }

                .item-modal-price-overlay {
                    font-size: 20px;
                    padding: 10px 16px;
                }
            }
        </style>

        <body>
            <div class="product-container shop-profile-container">
                <!-- LEFT COLUMN: Shop Details -->
                <div class="main-content">

                    <!-- Shop Main Card -->
                    <section class="card-section">
                        <div class="product-showcase">
                            <!-- Image -->
                            <div class="main-image-wrapper">
                                <% if(shop.shopImage && shop.shopImage.length> 0) { %>
                                    <img src="<%= shop.shopImage[0].url %>" alt="<%= shop.shopName %>"
                                        class="main-image" id="mainImage" />
                                    <% } else { %>
                                        <div class="main-image"
                                            style="background:#eee; display:flex; align-items:center; justify-content:center;">
                                            No Image</div>
                                        <% } %>
                                            <button class="btn-share" id="shareBtn" type="button" title="Share Shop">
                                                <i class="fa-solid fa-share-nodes"></i>
                                            </button>
                            </div>

                            <!-- Info -->
                            <div class="product-info-header">
                                <h1 class="product-title">
                                    <%= shop.shopName %>
                                </h1>
                                <div class="seller-badge" style="cursor:pointer;" onclick="openUpiModal()">
                                    <i class="fa-solid fa-qrcode"></i> QR Code
                                </div>

                                <div class="info-grid">
                                    <div class="info-box">
                                        <span class="info-label">Owner</span>
                                        <span class="info-value">
                                            <%= shop.owner.name %>
                                        </span>
                                    </div>
                                    <div class="info-box">
                                        <span class="info-label">Location</span>
                                        <span class="info-value">
                                            <%= shop.location %>
                                        </span>
                                    </div>
                                    <a href="tel:<%= shop.owner.username %>" class="info-box"
                                        style="text-decoration:none; justify-content:center; align-items:center; background:#eff6ff; border-color:#bfdbfe;">
                                        <span class="info-value" style="color:#2563eb; font-size:16px;">
                                            <i class="fa-solid fa-phone"></i> Call Owner
                                        </span>
                                    </a>
                                </div>

                                <!-- Owner Actions -->
                                <% if (currUser && shop.owner._id.equals(currUser._id)) { %>
                                    <div class="owner-actions">
                                        <a href="/shops/<%= shop._id %>/edit" class="btn btn-warning">
                                            <i class="fa-solid fa-edit"></i> Edit
                                        </a>
                                    </div>
                                    <% } %>
                            </div>
                        </div>
                    </section>

                    <!-- Description -->
                    <section class="card-section">
                        <h2 class="section-heading">About this Shop</h2>
                        <p class="description-text">
                            <%= shop.shopDescription || "No description provided." %>
                        </p>
                    </section>





                    </section>

                    <!-- Independent Items Section -->
                    <div style="margin-top: 20px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding: 0 5px;">
                            <h2 style="font-size:1.5rem; font-weight:700; margin:0; color:var(--text-main);">Shop Items
                            </h2>
                            <% if (currUser && shop.owner._id.equals(currUser._id)) { %>
                                <button id="addItemBtn" class="btn-add-item" style="margin:0;"><i
                                        class="fa-solid fa-plus"></i> Add Item</button>
                                <% } %>
                        </div>

                        <% if(currentShopCats) { %>
                            <!-- Dynamic Category Slider -->
                            <div class="cat-scroll-wrapper-container"
                                style="position:sticky; top:60px; z-index:90; background-color:var(--bg-color); padding-top:10px; margin-bottom:10px;">
                                <div class="cat-scroll-wrapper" id="categorySlider" style="padding-bottom:10px;">
                                    <span class="cat-pill active" onclick="filterItems('All', this)">All Items</span>
                                    <% currentShopCats.forEach(cat=> { %>
                                        <span class="cat-pill" onclick="filterItems('<%= cat.name %>', this)">
                                            <%= cat.icon %>
                                                <%= cat.name %>
                                        </span>
                                        <% }) %>
                                </div>
                            </div>
                            <% } %>

                                <div class="items-grid" id="itemsGrid">
                                    <% if(shop.items && shop.items.length> 0) { %>
                                        <% shop.items.forEach(item=> { %>
                                            <div class="product-card item-card-filter"
                                                data-category="<%= (item.itemCategory === 'Other' || item.itemCategory === 'Others' || !item.itemCategory) ? 'General' : item.itemCategory %>"
                                                data-name="<%= item.name %>"
                                                data-img="<%= item.img && item.img.url ? item.img.url : '' %>"
                                                data-price="<%= item.price %>" data-owner="<%= shop.owner.username %>"
                                                onclick="openItemModal(this)" style="cursor: pointer;">
                                                <div class="product-img-wrap">
                                                    <% if(item.img && item.img.url) { %>
                                                        <img src="<%= item.img.url %>" alt="<%= item.name %>">
                                                        <% } else { %>
                                                            <div
                                                                style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#999; font-size:12px;">
                                                                No Image</div>
                                                            <% } %>
                                                                <div class="price-tag">
                                                                    â‚¹<%= item.price %>
                                                                </div>
                                                </div>

                                                <div class="card-body-custom">
                                                    <h5 class="prod-title">
                                                        <%= item.name %>
                                                    </h5>
                                                    <div class="prod-meta">
                                                        <span>Qty: <%= item.quantity %></span>
                                                    </div>

                                                    <% if (currUser && shop.owner._id.equals(currUser._id)) { %>
                                                        <div class="item-action-buttons">
                                                            <button type="button" class="item-edit-btn"
                                                                onclick="event.stopPropagation(); openEditItemModal('<%= item._id %>', '<%= item.name %>', '<%= item.price %>', '<%= item.quantity %>', '<%= item.itemCategory || '' %>')">
                                                                <i class="fa-solid fa-edit"></i> Edit
                                                            </button>
                                                            <button type="button" class="item-delete-btn"
                                                                onclick="event.stopPropagation(); openDeleteConfirm('<%= shop._id %>', '<%= item._id %>')">
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </button>
                                                        </div>
                                                        <% } %>
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } else { %>
                                                    <p style="color:#6b7280; grid-column: 1 / -1; text-align:center;">
                                                        No
                                                        items added yet.</p>
                                                    <% } %>
                                </div>

                                <script>
                                    function filterItems(category, element) {
                                        // Update active state
                                        document.querySelectorAll('.cat-pill').forEach(el => el.classList.remove('active'));
                                        element.classList.add('active');

                                        // Filter items
                                        const items = document.querySelectorAll('.item-card-filter');
                                        let count = 0;

                                        items.forEach(item => {
                                            const itemCat = item.getAttribute('data-category');
                                            if (category === 'All' || itemCat === category) {
                                                item.style.display = 'flex';
                                                count++;
                                            } else {
                                                item.style.display = 'none';
                                            }
                                        });
                                    }
                                </script>
                    </div>

                    <!-- Gallery (only if multiple images) -->
                    <% if (shop.shopImage && shop.shopImage.length> 1) { %>
                        <section class="card-section" style="margin-top: 30px;">
                            <h2 class="section-heading">Shop Gallery</h2>
                            <div class="gallery-grid">
                                <% shop.shopImage.forEach((image, index)=> { %>
                                    <img src="<%= image.url %>" alt="Shop Image" class="gallery-img">
                                    <% }) %>
                            </div>
                        </section>
                        <% } %>

                            <!-- REVIEWS SECTION -->
                            <section class="reviews-card" id="reviewsSection">
                                <div class="head"
                                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                                    <div>
                                        <h2 style="font-size:20px; font-weight:700; margin:0;">Reviews & Ratings
                                        </h2>
                                        <p style="color:#6b7280; font-size:14px; margin:4px 0 0 0;">What
                                            customers are
                                            saying</p>
                                    </div>
                                </div>

                                <!-- Review Form -->
                                <form class="review-form" action="/shops/<%= shop._id %>/reviews" method="POST">
                                    <div class="field">
                                        <label>Rating</label>
                                        <select required name="review[ratings]">
                                            <option value="5" selected>5 - Excellent</option>
                                            <option value="4">4 - Good</option>
                                            <option value="3">3 - Average</option>
                                            <option value="2">2 - Poor</option>
                                            <option value="1">1 - Bad</option>
                                        </select>
                                    </div>

                                    <div class="field">
                                        <label>Comment</label>
                                        <textarea rows="3" placeholder="Write your review..." required
                                            name="review[comment]"></textarea>
                                    </div>

                                    <div class="form-actions">
                                        <button class="btn btn-primary">Submit Review</button>
                                    </div>
                                </form>

                                <div style="border-top:1px solid #e5e7eb; margin:24px 0;"></div>

                                <!-- Reviews List -->
                                <div class="reviews-list">
                                    <% if(shop.reviews && shop.reviews.length> 0) { %>
                                        <% for (let review of shop.reviews){ %>
                                            <div class="review-card">
                                                <div class="review-top">
                                                    <div class="review-user">
                                                        <div class="avatar">
                                                            <%= review.author.name.charAt(0).toUpperCase() %>
                                                        </div>
                                                        <div>
                                                            <div class="user-name">
                                                                <%= review.author.name %>
                                                            </div>
                                                            <div class="user-sub">
                                                                <%= review.createdAt ? review.createdAt.toDateString()
                                                                    : '' %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="rating">
                                                        <% for(let i=0; i<review.ratings; i++) { %>â˜…<% } %>
                                                                <span style="color:#ccc; font-size:12px;">(<%=
                                                                        review.ratings %>
                                                                        /5)</span>
                                                    </div>
                                                </div>
                                                <p class="review-comment">
                                                    <%= review.comment %>
                                                </p>

                                                <% if(currUser && review.author._id.equals(currUser._id)) { %>
                                                    <form
                                                        action="/shops/<%= shop._id %>/reviews/<%= review._id %>?_method=DELETE"
                                                        method="POST" style="margin-top:10px;">
                                                        <button class="btn btn-sm btn-danger"
                                                            style="padding:4px 8px; font-size:12px;">Delete</button>
                                                    </form>
                                                    <% } %>
                                            </div>
                                            <% } %>
                                                <% } else { %>
                                                    <p class="text-muted text-center py-4">No reviews yet. Be
                                                        the first to
                                                        review!</p>
                                                    <% } %>
                                </div>
                            </section>

                </div>


            </div>

            <!-- Add Item Modal -->
            <div id="addItemModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 style="margin-bottom:20px;">Add New Item</h2>
                    <form action="/shops/<%= shop._id %>/items" method="POST" enctype="multipart/form-data"
                        class="review-form">
                        <div class="field">
                            <label>Item Name</label>
                            <input type="text" name="item[name]" required placeholder="Enter item name"
                                style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                        </div>
                        <div class="field">
                            <label>Price (â‚¹)</label>
                            <input type="number" name="item[price]" required min="0" placeholder="0"
                                style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                        </div>
                        <div class="field">
                            <label>Quantity</label>
                            <input type="number" name="item[quantity]" required min="1" placeholder="1"
                                style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                        </div>

                        <% if(currentShopCats) { %>
                            <div class="field">
                                <label>Item Category</label>
                                <select name="item[itemCategory]" class="form-control"
                                    style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;"
                                    required>
                                    <option value="" disabled selected>Select Category</option>
                                    <% currentShopCats.forEach(cat=> { %>
                                        <option value="<%= cat.name %>">
                                            <%= cat.icon %>
                                                <%= cat.name %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>
                            <% } %>
                                <div class="field">
                                    <label>Item Image</label>
                                    <input type="file" name="itemImage" id="itemImageInput" required
                                        style="width:100%; padding:10px; background:#f9fafb; border:1px solid #d1d5db; border-radius:8px;">
                                </div>
                                <button class="btn btn-primary w-100" id="addItemSubmitBtn">Add Item</button>
                    </form>
                </div>
            </div>

            <!-- Edit Item Modal -->
            <div id="editItemModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeEditItemModal()">&times;</span>
                    <h2 style="margin-bottom:20px;">Edit Item</h2>
                    <form id="editItemForm" method="POST" class="review-form">
                        <input type="hidden" id="editItemId" name="itemId">
                        <div class="field">
                            <label>Item Name</label>
                            <input type="text" id="editItemName" name="item[name]" required
                                placeholder="Enter item name"
                                style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                        </div>
                        <div class="field">
                            <label>Price (â‚¹)</label>
                            <input type="number" id="editItemPrice" name="item[price]" required min="0" placeholder="0"
                                style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                        </div>
                        <div class="field">
                            <label>Quantity</label>
                            <input type="number" id="editItemQuantity" name="item[quantity]" required min="1"
                                placeholder="1"
                                style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">
                        </div>

                        <% if(currentShopCats) { %>
                            <div class="field">
                                <label>Item Category</label>
                                <select id="editItemCategory" name="item[itemCategory]" class="form-control"
                                    style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;"
                                    required>
                                    <option value="" disabled>Select Category</option>
                                    <% currentShopCats.forEach(cat=> { %>
                                        <option value="<%= cat.name %>">
                                            <%= cat.icon %>
                                                <%= cat.name %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>
                            <% } %>
                                <button type="submit" class="btn btn-primary w-100">Update Item</button>
                    </form>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="deleteModal" class="modal" style="z-index: 1100;">
                <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <div
                            style="width: 60px; height: 60px; background: #fee2e2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 24px;">
                            <i class="fa-solid fa-trash-can"></i>
                        </div>
                        <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">Delete
                            Item?
                        </h3>
                        <p style="color: #6b7280; font-size: 15px; line-height: 1.5;">
                            Are you sure you want to delete this item? This action cannot be undone.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button class="btn"
                            style="background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; width: 100%;"
                            onclick="closeDeleteModal()">
                            Cancel
                        </button>
                        <form id="deleteForm" method="POST" style="margin:0; width: 100%;">
                            <button class="btn btn-danger" style="width: 100%; justify-content: center;">
                                Yes, Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- NEW: Item Detail Modal -->
            <div id="itemModal" class="item-modal">
                <div class="item-modal-card">
                    <button class="item-modal-close" onclick="closeItemModal()">&times;</button>
                    <div class="item-modal-header">
                        <h2 class="item-modal-title" id="modalItemName"></h2>
                    </div>
                    <div class="item-modal-body">
                        <div class="item-modal-img-wrapper">
                            <img id="modalItemImage" class="item-modal-img" alt="Item">
                            <div class="item-modal-price-overlay" id="modalItemPrice"></div>
                        </div>
                        <a id="modalWhatsappLink" href="#" target="_blank" class="item-modal-whatsapp-btn">
                            <i class="fa-brands fa-whatsapp"></i> Order on WhatsApp
                        </a>
                    </div>
                </div>
            </div>

            <!-- UPI Modal -->
            <div id="upiModal" class="modal">
                <div class="modal-content" style="text-align:center;">
                    <span class="close" onclick="closeUpiModal()">&times;</span>
                    <h2 style="margin-bottom:20px;">Scan to Pay</h2>

                    <% if (shop.upiScanner && shop.upiScanner.url) { %>
                        <div style="margin-bottom:20px;">
                            <img src="<%= shop.upiScanner.url %>" alt="UPI QR Code"
                                style="max-width:100%; border-radius:12px; border:1px solid #e5e7eb;">
                        </div>
                        <% if (currUser && shop.owner._id.equals(currUser._id)) { %>
                            <form action="/shops/<%= shop._id %>/upi?_method=DELETE" method="POST">
                                <button class="btn btn-danger w-100"><i class="fa-solid fa-trash"></i> Remove QR
                                    Code</button>
                            </form>
                            <% } %>
                                <% } else if (currUser && shop.owner._id.equals(currUser._id)) { %>
                                    <div style="padding:20px; border:2px dashed #d1d5db; border-radius:12px;">
                                        <i class="fa-solid fa-qrcode fa-3x"
                                            style="color:#9ca3af; margin-bottom:15px;"></i>
                                        <p style="color:#6b7280; margin-bottom:20px;">Upload your UPI QR Code image.
                                        </p>
                                        <form action="/shops/<%= shop._id %>/upi?_method=PUT" method="POST"
                                            enctype="multipart/form-data" id="upiModalForm">
                                            <input type="file" name="upiImage" id="upiModalInput" accept="image/*"
                                                style="display:none;"
                                                onchange="document.getElementById('upiModalForm').submit()">
                                            <button type="button" class="btn btn-primary w-100"
                                                onclick="document.getElementById('upiModalInput').click()">
                                                <i class="fa-solid fa-upload"></i> Upload QR Image
                                            </button>
                                        </form>
                                    </div>
                                    <% } else { %>
                                        <div style="padding:40px 20px;">
                                            <i class="fa-solid fa-ban fa-3x"
                                                style="color:#ef4444; margin-bottom:15px;"></i>
                                            <h3 style="color:#4b5563;">No QR Code Available</h3>
                                            <p style="color:#6b7280;">The shop owner hasn't uploaded a UPI QR code
                                                yet.</p>
                                        </div>
                                        <% } %>
                </div>
            </div>

            <script>
                // NEW: Open Item Modal
                function openItemModal(element) {
                    const name = element.getAttribute('data-name');
                    const imgUrl = element.getAttribute('data-img');
                    const price = element.getAttribute('data-price');
                    const ownerPhone = element.getAttribute('data-owner');
                    const modal = document.getElementById('itemModal');
                    const nameEl = document.getElementById('modalItemName');
                    const imgEl = document.getElementById('modalItemImage');
                    const priceEl = document.getElementById('modalItemPrice');
                    const whatsappLink = document.getElementById('modalWhatsappLink');

                    nameEl.textContent = name;
                    imgEl.src = imgUrl || '/images/placeholder.jpg';
                    priceEl.textContent = 'â‚¹' + price;

                    const message = `Hi, I am interested in ${name} priced at â‚¹${price}.\n\nView item image: ${imgUrl}\n\nIs it available?`;
                    whatsappLink.href = `https://wa.me/91${ownerPhone}?text=${encodeURIComponent(message)}`;

                    modal.style.display = 'flex';
                }

                function closeItemModal() {
                    document.getElementById('itemModal').style.display = 'none';
                }

                function openUpiModal() {
                    document.getElementById('upiModal').style.display = 'block';
                }

                function closeUpiModal() {
                    document.getElementById('upiModal').style.display = 'none';
                }

                // Close modals when clicking outside
                window.addEventListener('click', function (event) {
                    const itemModal = document.getElementById('itemModal');
                    const addModal = document.getElementById('addItemModal');
                    const deleteModal = document.getElementById('deleteModal');
                    const upiModal = document.getElementById('upiModal');

                    if (event.target === itemModal) closeItemModal();
                    if (event.target === addModal) addModal.style.display = 'none';
                    if (event.target === deleteModal) deleteModal.style.display = 'none';
                    if (event.target === upiModal) closeUpiModal();
                });
            </script>

            <!-- Script for gallery/share same as productDetail -->
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    // Modal Logic
                    const modal = document.getElementById("addItemModal");
                    const btn = document.getElementById("addItemBtn");
                    const span = document.getElementsByClassName("close")[0];

                    if (btn) {
                        btn.onclick = function () {
                            modal.style.display = "block";
                        }
                    }

                    if (span) {
                        span.onclick = function () {
                            modal.style.display = "none";
                        }
                    }

                    window.onclick = function (event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                        }
                        if (event.target == document.getElementById("deleteModal")) {
                            closeDeleteModal();
                        }
                    }

                    // Existing Logic
                    const shareBtn = document.getElementById('shareBtn');
                    if (shareBtn) {
                        shareBtn.addEventListener('click', async () => {
                            if (navigator.share) {
                                try {
                                    await navigator.share({
                                        title: '<%= shop.shopName %>',
                                        text: 'Check out this shop on Local Bazzar!',
                                        url: window.location.href
                                    });
                                } catch (err) { console.log(err); }
                            } else {
                                navigator.clipboard.writeText(window.location.href);
                                alert('Link copied!');
                            }
                        });
                    }

                    const galleryImages = document.querySelectorAll('.gallery-img');
                    const mainImage = document.getElementById('mainImage');
                    if (mainImage && galleryImages.length > 0) {
                        galleryImages.forEach(img => {
                            img.addEventListener('click', () => {
                                mainImage.src = img.src;
                            });
                        });
                    }
                });

                // Edit Item Modal Functions
                function openEditItemModal(itemId, itemName, itemPrice, itemQuantity, itemCategory) {
                    const modal = document.getElementById('editItemModal');
                    document.getElementById('editItemId').value = itemId;
                    document.getElementById('editItemName').value = itemName;
                    document.getElementById('editItemPrice').value = itemPrice;
                    document.getElementById('editItemQuantity').value = itemQuantity;

                    const categorySelect = document.getElementById('editItemCategory');
                    if (categorySelect && itemCategory) {
                        categorySelect.value = itemCategory;
                    }

                    // Set form action
                    const form = document.getElementById('editItemForm');
                    form.action = `/shops/<%= shop._id %>/items/${itemId}?_method=PUT`;

                    modal.style.display = "block";
                }

                function closeEditItemModal() {
                    const modal = document.getElementById('editItemModal');
                    modal.style.display = "none";
                }

                // Delete Modal Functions
                function openDeleteConfirm(shopId, itemId) {
                    const modal = document.getElementById('deleteModal');
                    const form = document.getElementById('deleteForm');
                    form.action = `/shops/${shopId}/items/${itemId}?_method=DELETE`;
                    modal.style.display = "flex"; // Flex to center if we want, or block
                    modal.style.alignItems = "center";
                    modal.style.justifyContent = "center";
                }

                function closeDeleteModal() {
                    const modal = document.getElementById('deleteModal');
                    modal.style.display = "none";
                }

                // Image Compression Logic
                document.getElementById('itemImageInput').addEventListener('change', async function (event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // 500KB limit
                    const MAX_SIZE = 500 * 1024;

                    if (file.size <= MAX_SIZE) return;

                    const submitBtn = document.getElementById('addItemSubmitBtn');
                    const originalText = submitBtn.innerText;
                    submitBtn.innerText = "Compressing Image...";
                    submitBtn.disabled = true;

                    try {
                        const compressedFile = await compressImage(file, MAX_SIZE);

                        // Replace the file input with compressed file
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        event.target.files = dataTransfer.files;

                        console.log(`Compressed: ${(compressedFile.size / 1024).toFixed(2)}KB (Original: ${(file.size / 1024).toFixed(2)}KB)`);
                    } catch (err) {
                        console.error("Compression failed", err);
                    } finally {
                        submitBtn.innerText = originalText;
                        submitBtn.disabled = false;
                    }
                });

                function compressImage(file, maxSize) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;

                                // Initial resize if huge
                                const MAX_DIMENSION = 1920;
                                if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
                                    if (width > height) {
                                        height *= MAX_DIMENSION / width;
                                        width = MAX_DIMENSION;
                                    } else {
                                        width *= MAX_DIMENSION / height;
                                        height = MAX_DIMENSION;
                                    }
                                }

                                canvas.width = width;
                                canvas.height = height;

                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);

                                // Recursive compression
                                let quality = 0.9;

                                function tryCompress() {
                                    canvas.toBlob((blob) => {
                                        if (blob.size <= maxSize || quality <= 0.1) {
                                            const newFile = new File([blob], file.name, {
                                                type: 'image/jpeg',
                                                lastModified: Date.now(),
                                            });
                                            resolve(newFile);
                                        } else {
                                            quality -= 0.1;
                                            tryCompress();
                                        }
                                    }, 'image/jpeg', quality);
                                }

                                tryCompress();
                            };
                            img.onerror = reject;
                        };
                        reader.onerror = reject;
                    });
                }
            </script>
        </body>