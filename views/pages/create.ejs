<% layout('./layoutes/boilerplate.ejs') -%>
  <link rel="stylesheet" href="/css/auth.css">

  <body>
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1 class="auth-title">Become a Provider</h1>
          <p class="auth-subtitle">Join our network and grow your business</p>
          <div class="badge-info mt-3">
            <i class="fa-solid fa-circle-info"></i> Fields marked with (*) are mandatory
          </div>
          <div class="text-danger small mt-2 notranslate">
            Please fill details in English / ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§Æ‡•á‡§Ç ‡§≠‡§∞‡•á‡§Ç
          </div>
        </div>

        <form method="POST" action="/become/provider" novalidate class="needs-validation notranslate"
          enctype="multipart/form-data">

          <!-- Company Name -->
          <div class="form-group">
            <label for="companyName" class="form-label">Company / Service Name *</label>
            <input type="text" class="form-control" id="companyName" required name="provider[company]"
              placeholder="e.g. PaSr Services Pvt Ltd">
            <div class="invalid-feedback">Please enter your company/service name.</div>
          </div>

          <!-- Experience -->
          <div class="form-group">
            <label for="experience" class="form-label">Years of Experience *</label>
            <input type="number" class="form-control" id="experience" required name="provider[experience]"
              placeholder="e.g. 3">
            <div class="invalid-feedback">Required to build customer trust.</div>
          </div>

          <!-- Location -->
          <div class="form-group">
            <label for="locationInput" class="form-label">Company Location *</label>
            <div class="input-group">
              <input type="text" class="form-control" id="locationInput" required name="provider[location]"
                placeholder="City, Area or Street">
              <button class="btn-location" type="button" id="getLocationBtn">
                <i class="fa-solid fa-location-crosshairs"></i> Get Location
              </button>
            </div>
            <div class="invalid-feedback">Please provide your operational location.</div>
          </div>

          <!-- Phone -->
          <div class="form-group">
            <label for="phoneInput" class="form-label">Additional Phone Number</label>
            <input type="number" class="form-control" id="phoneInput" name="provider[phoneNO]"
              placeholder="e.g. 9876543210 (Optional)">
            <div class="form-text text-muted small mt-1">Useful as a backup contact.</div>
          </div>

          <!-- Service Category -->
          <div class="form-group">
            <label class="form-label">Service Category *</label>
            <select class="form-control form-select" required name="provider[categories]">
              <option value="" disabled selected>Select service type...</option>
              <option value="Farming Vehicles">üöú Farming Vehicles</option>
              <option value="Four Wheelers">üöó Four Wheelers</option>
              <option value="HMV (Bus)">üöå HMV (Bus)</option>
              <option value="Three Wheelers">üõ∫ Three Wheelers</option>
              <option value="Caterings">üçΩÔ∏è Caterings</option>
              <option value="Filming">üé• Filming</option>
              <option value="Decoration">‚ú® Decoration</option>
              <option value="DJ and Tent">üéµ DJ and Tent</option>
              <option value="Band Party">üé∫ Band Party</option>
              <option value="Home Service provider">üõ†Ô∏è Home Service Provider</option>
              <option value="Heavy Equipments">üèóÔ∏è Heavy Equipments</option>
              <option value="Others">üîπ Others</option>
            </select>
          </div>

          <!-- Image Upload -->
          <div class="form-group mt-4">
            <label class="form-label">Service Image (You with Service) *</label>
            <div class="p-3 border rounded bg-light text-center">
              <img src="/images/person_car.png" alt="example" class="img-fluid rounded mb-3"
                style="max-height: 150px; opacity: 0.7;">
              <input type="file" name="provider[personImage]" required class="form-control">
              <div class="form-text mt-2">Upload a photo of you with your vehicle/service setup to build trust.</div>
            </div>
          </div>

          <!-- Agreement -->
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="confirmCheck" required>
            <label class="form-check-label" for="confirmCheck">
              <b>I confirm that the information provided is correct and represents my actual service.</b>
            </label>
          </div>

          <button class="btn-submit">Register as Provider</button>
        </form>
      </div>
    </div>

    <!-- Location Script -->
    <script>
      document.getElementById('getLocationBtn').addEventListener('click', () => {
        const btn = document.getElementById('getLocationBtn');
        const input = document.getElementById('locationInput');

        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser");
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Locating...';

        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        };
        navigator.geolocation.getCurrentPosition(async (position) => {
          const { latitude, longitude } = position.coords;
          try {
            const res = await fetch(`/get-address?lat=${latitude}&lon=${longitude}`);
            const data = await res.json();
            if (data.address) {
              input.value = data.address;
            } else {
              alert("Could not find address for this location.");
            }
          } catch (err) {
            console.error(err);
            alert("Failed to fetch address.");
          } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Get Location';
          }
        }, (err) => {
          console.error(err);

          let msg = "Unable to retrieve location.";
          if (err.code === 1) msg = "Location permission denied. Please allow access.";
          else if (err.code === 2) msg = "Location unavailable. Check your GPS/Network.";
          else if (err.code === 3) msg = "Location request timed out.";

          alert(`${msg}\n(Error: ${err.message})`);

          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Get Location';
        });
      });
    </script>
    <script src="/js/script.js"></script>
  </body>