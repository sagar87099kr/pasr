<% layout('./layoutes/boilerplate.ejs') -%>
    <link rel="stylesheet" href="/css/auth.css">

    <body>
        <div class="auth-container">
            <div class="auth-card seller-card">
                <div class="auth-header">
                    <h1 class="auth-title">Edit Shop Details</h1>
                    <p class="auth-subtitle">Update your shop information</p>
                </div>

                <form action="/shops/<%= shop._id %>?_method=PUT" method="POST" novalidate
                    class="needs-validation notranslate">

                    <!-- Shop Name -->
                    <div class="form-group">
                        <label for="shopName" class="form-label">Shop Name *</label>
                        <input type="text" name="shop[shopName]" id="shopName" class="form-control"
                            value="<%= shop.shopName %>" required>
                        <div class="invalid-feedback">Please provide a shop name.</div>
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label for="category" class="form-label">Category *</label>
                        <select class="form-control form-select" name="shop[category]" id="category" required>
                            <option disabled value="">Select Category...</option>
                            <% const categories=["Automobile", "Bakery" , "Dhaba" , "Electronics" , "Fashion"
                                , "Footwear" , "Furniture" , "General Store" , "Grocery" , "Hardware" , "Jewelers"
                                , "Medical" , "Mobile Shop" , "Non-Veg" , "Printing & Digital" , "Restaurant" , "Salon"
                                , "Seeds & Fertilizers" , "Stationery" , "Others" ]; %>
                                <% categories.forEach(cat=> { %>
                                    <option value="<%= cat %>" <%=shop.category===cat ? 'selected' : '' %>><%= cat %>
                                    </option>
                                    <% }) %>
                        </select>
                        <div class="invalid-feedback">Please select a category.</div>
                    </div>

                    <!-- Location -->
                    <div class="form-group">
                        <label for="location" class="form-label">Location / Address *</label>
                        <div class="input-group">
                            <input type="text" name="shop[location]" id="location" class="form-control"
                                value="<%= shop.location %>" placeholder="Type address or click 'Get Location'..."
                                required>
                            <button class="btn-location" type="button" id="getShopLocBtn"
                                style="background: #2563eb; color: white; border: none; padding: 0 15px; border-radius: 0 8px 8px 0; font-weight: 500;">
                                <i class="fa-solid fa-location-crosshairs"></i> Get Location
                            </button>
                        </div>
                        <div class="invalid-feedback">Please provide a location.</div>
                    </div>

                    <!-- Operating Hours -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="openingTime" class="form-label">Opening Time</label>
                                <input type="time" name="shop[openingTime]" id="openingTime" class="form-control"
                                    value="<%= shop.openingTime || '' %>">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="closingTime" class="form-label">Closing Time</label>
                                <input type="time" name="shop[closingTime]" id="closingTime" class="form-control"
                                    value="<%= shop.closingTime || '' %>">
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="shopDescription" class="form-label">Description</label>
                        <textarea name="shop[shopDescription]" id="shopDescription" class="form-control" rows="4"
                            placeholder="Describe what you sell..."><%= shop.shopDescription %></textarea>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button class="btn-submit flex-grow-1">
                            <i class="fa-solid fa-save"></i> Save Changes
                        </button>
                        <a href="/shops/<%= shop._id %>"
                            class="btn btn-secondary flex-grow-0 d-flex align-items-center px-4"
                            style="border-radius: 8px;">
                            Cancel
                        </a>
                    </div>

                </form>
            </div>
        </div>

        <script>
            const locBtn = document.getElementById('getShopLocBtn');
            const locInput = document.getElementById('location');

            if (locBtn) {
                locBtn.addEventListener('click', () => {
                    if (!navigator.geolocation) {
                        alert("Geolocation is not supported by your browser");
                        return;
                    }

                    const originalText = locBtn.innerHTML;
                    locBtn.disabled = true;
                    locBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Fetching...';

                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    };
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const response = await fetch(`/get-address?lat=${latitude}&lon=${longitude}`);
                            const data = await response.json();
                            if (data.address) {
                                locInput.value = data.address;
                            } else {
                                alert("Address not found for this location.");
                            }
                        } catch (error) {
                            console.error("Error fetching address:", error);
                            alert("Failed to fetch address details.");
                        } finally {
                            locBtn.disabled = false;
                            locBtn.innerHTML = originalText;
                        }
                    }, (error) => {
                        console.error("Geolocation error:", error);
                        alert("Unable to retrieve location. Please check permissions.");
                        locBtn.disabled = false;
                        locBtn.innerHTML = originalText;
                    });
                });
            }
        </script>
    </body>