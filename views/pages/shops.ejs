<% layout('./layoutes/boilerplate.ejs') -%>
    <link rel="stylesheet" href="/css/localMarket.css">

    <!-- Floating Action Button for Sellers -->
    <a href="/shops/new" class="fab-sell" title="Register Shop">
        <i class="fa-solid fa-plus"></i>
    </a>

    <!-- Header Section -->
    <div class="market-header">
        <div class="container">
            <h2 class="market-title">
                <i class="fa-solid fa-store"></i> Local Shops
            </h2>
            <% if (lat && lng) { %>
                <span class="location-badge">
                    <i class="fa-solid fa-location-dot"></i> Near You (<%= range || 5 %>km)
                </span>
                <% } %>
        </div>
    </div>

    <div class="container">

        <!-- Location Prompt -->
        <% if (!lat || !lng) { %>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="location-request-card">
                        <div class="location-icon-circle">
                            <i class="fa-solid fa-map-location-dot fa-2x"></i>
                        </div>
                        <h3>Find Nearby Shops</h3>
                        <p class="text-muted mb-4">Discover local businesses and services in your neighborhood. We
                            need your location to show you what's nearby.</p>
                        <button id="getLocationBtn" class="btn btn-locate">
                            <i class="fa-solid fa-crosshairs"></i> Detect My Location
                        </button>
                    </div>
                </div>
            </div>
            <% } else { %>

                <!-- Range Control -->
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="range-control-panel">
                            <label for="rangeSlider" class="form-label d-flex justify-content-between fw-bold mb-2">
                                <span>Search Radius</span>
                                <span class="badge bg-secondary"><span id="rangeValue">
                                        <%= range || 10 %>
                                    </span> km</span>
                            </label>
                            <input type="range" class="form-range" min="1" max="10" step="1" id="rangeSlider"
                                value="<%= range || 10 %>">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small">
                                    <span>1 km</span>
                                    <span class="mx-3">10 km</span>
                                </div>
                                <button id="applyRangeBtn" class="btn btn-primary btn-sm">
                                    <i class="fa-solid fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Search Bar -->
                <div class="row justify-content-center mb-3">
                    <div class="col-md-8 col-lg-6">
                        <div class="position-relative">
                            <input type="text" id="shopSearchInput" class="form-control" placeholder="Search shops..."
                                value="<%= typeof query !== 'undefined' ? query : '' %>">
                            <i class="fa-solid fa-search position-absolute"
                                style="right: 15px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                        </div>

                        <!-- Open Now Filter -->
                        <div class="form-check form-switch mt-2 d-flex justify-content-center align-items-center gap-2">
                            <input class="form-check-input" type="checkbox" id="openNowSwitch" style="cursor: pointer;">
                            <label class="form-check-label" for="openNowSwitch"
                                style="cursor: pointer; font-weight: 500;">
                                Open Now Only
                            </label>
                        </div>
                    </div>
                </div>
                <!-- Categories Scroll (Dynamic links preserving query params) -->
                <% const catIcons={ "Grocery" : "üõí" , "Electronics" : "üîå" , "Fashion" : "üëï" , "Medical" : "üíä"
                    , "Hardware" : "üõ†Ô∏è" , "Restaurant" : "üçΩÔ∏è" , "Dhaba" : "ü•ò" , "Bakery" : "üç∞" , "Mobile Shop"
                    : "üì±" , "Stationery" : "üìö" , "Salon" : "üíá" , "Jewelers" : "üíç" , "Non-Veg" : "üçñ"
                    , "General Store" : "üè™" , "Furniture" : "ü™ë" , "Seeds & Fertilizers" : "üå±" , "Automobile" : "üöó"
                    , "Printing & Digital" : "üñ®Ô∏è" , "Others" : "üì¶" }; const currentCat=(typeof queryParams
                    !=='undefined' && queryParams.category) ? queryParams.category : 'All Shops' ; const
                    makeCatLink=(catName)=> {
                    let params = new URLSearchParams();
                    if (lat) params.set('lat', lat);
                    if (lng) params.set('lng', lng);
                    if (range) params.set('range', range);
                    if (typeof queryParams !== 'undefined' && queryParams.openNow) {
                    params.set('openNow', queryParams.openNow);
                    }
                    params.set('category', catName);
                    return `/shops?${params.toString()}`;
                    }
                    %>
                    <div class="cat-scroll-wrapper">
                        <a href="<%= makeCatLink('All Shops') %>"
                            class="cat-pill <%= currentCat === 'All Shops' ? 'active' : '' %>">üè™ All Shops</a>
                        <a href="<%= makeCatLink('Grocery') %>"
                            class="cat-pill <%= currentCat === 'Grocery' ? 'active' : '' %>">üõí Grocery</a>
                        <a href="<%= makeCatLink('Electronics') %>"
                            class="cat-pill <%= currentCat === 'Electronics' ? 'active' : '' %>">üîå Electronics</a>
                        <a href="<%= makeCatLink('Fashion') %>"
                            class="cat-pill <%= currentCat === 'Fashion' ? 'active' : '' %>">üëï Fashion</a>
                        <a href="<%= makeCatLink('Medical') %>"
                            class="cat-pill <%= currentCat === 'Medical' ? 'active' : '' %>">üíä Medical</a>
                        <a href="<%= makeCatLink('Hardware') %>"
                            class="cat-pill <%= currentCat === 'Hardware' ? 'active' : '' %>">üõ†Ô∏è Hardware</a>
                        <a href="<%= makeCatLink('Restaurant') %>"
                            class="cat-pill <%= currentCat === 'Restaurant' ? 'active' : '' %>">üçΩÔ∏è Restaurant</a>
                        <a href="<%= makeCatLink('Dhaba') %>"
                            class="cat-pill <%= currentCat === 'Dhaba' ? 'active' : '' %>">ü•ò Dhaba</a>
                        <a href="<%= makeCatLink('Bakery') %>"
                            class="cat-pill <%= currentCat === 'Bakery' ? 'active' : '' %>">üç∞ Bakery</a>
                        <a href="<%= makeCatLink('Mobile Shop') %>"
                            class="cat-pill <%= currentCat === 'Mobile Shop' ? 'active' : '' %>">üì± Mobile Shop</a>
                        <a href="<%= makeCatLink('Stationery') %>"
                            class="cat-pill <%= currentCat === 'Stationery' ? 'active' : '' %>">üìö Stationery</a>
                        <a href="<%= makeCatLink('Salon') %>"
                            class="cat-pill <%= currentCat === 'Salon' ? 'active' : '' %>">üíá Salon</a>
                        <a href="<%= makeCatLink('Jewelers') %>"
                            class="cat-pill <%= currentCat === 'Jewelers' ? 'active' : '' %>">üíç Jewelers</a>
                        <a href="<%= makeCatLink('Non-Veg') %>"
                            class="cat-pill <%= currentCat === 'Non-Veg' ? 'active' : '' %>">üçñ Non-Veg</a>
                        <a href="<%= makeCatLink('General Store') %>"
                            class="cat-pill <%= currentCat === 'General Store' ? 'active' : '' %>">üè™ General Store</a>
                        <a href="<%= makeCatLink('Furniture') %>"
                            class="cat-pill <%= currentCat === 'Furniture' ? 'active' : '' %>">ü™ë Furniture</a>
                        <a href="<%= makeCatLink('Seeds & Fertilizers') %>"
                            class="cat-pill <%= currentCat === 'Seeds & Fertilizers' ? 'active' : '' %>">üå± Seeds &
                            Fertilizers</a>
                        <a href="<%= makeCatLink('Automobile') %>"
                            class="cat-pill <%= currentCat === 'Automobile' ? 'active' : '' %>">üöó Automobile</a>
                        <a href="<%= makeCatLink('Printing & Digital') %>"
                            class="cat-pill <%= currentCat === 'Printing & Digital' ? 'active' : '' %>">üñ®Ô∏è Printing &
                            Digital</a>
                        <a href="<%= makeCatLink('Others') %>"
                            class="cat-pill <%= currentCat === 'Others' ? 'active' : '' %>">üì¶ Others</a>
                    </div>


                    <!-- Shop Grid -->
                    <% if (shops && shops.length> 0) { %>
                        <div class="market-grid">
                            <% for (let shop of shops) { %>
                                <a href="/shops/<%= shop._id %>" class="product-card-link">
                                    <div class="product-card">
                                        <div class="product-img-wrap">
                                            <img src="<%= shop.shopImage[0].url %>" alt="<%= shop.shopName %>">
                                            <% let statusBadge='' ; if (shop.openingTime && shop.closingTime) { const
                                                now=new Date(); const options={ timeZone: 'Asia/Kolkata' , hour12:
                                                false, hour: '2-digit' , minute: '2-digit' }; const
                                                currentTime=now.toLocaleTimeString('en-US', options); if (currentTime>=
                                                shop.openingTime && currentTime <= shop.closingTime) {
                                                    statusBadge='<span class="badge bg-success position-absolute" style="top:10px; right:10px; z-index:10;">Open Now</span>'
                                                    ; } else {
                                                    statusBadge='<span class="badge bg-danger position-absolute" style="top:10px; right:10px; z-index:10;">Closed</span>'
                                                    ; } } %>
                                                    <%- statusBadge %>
                                        </div>
                                        <div class="card-body-custom">
                                            <h5 class="prod-title">
                                                <%= shop.shopName %>
                                            </h5>
                                            <p class="prod-desc">
                                                <i class="fa-solid fa-user"></i>
                                                <%= shop.owner.name %>
                                            </p>
                                            <div class="prod-meta">
                                                <span><i class="fa-solid fa-tag"></i>
                                                    <%= catIcons[shop.category] || '' %>
                                                        <%= shop.category %>
                                                </span>
                                                <span class="text-truncate" style="max-width: 100px;"><i
                                                        class="fa-solid fa-map-pin"></i>
                                                    <%= shop.location %>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                <% } %>
                        </div>
                        <% } else { %>
                            <!-- Empty State -->
                            <div class="alert alert-warning text-center mt-4" role="alert" style="border-radius: 12px;">
                                <i class="fa-solid fa-store-slash fa-3x mb-3 text-warning"></i>
                                <h4>No shops found nearby</h4>
                                <p>We couldn't find any shops within <%= range || 5 %>km.</p>
                                <p>Try increasing your search distance or checks back later.</p>
                            </div>
                            <% } %>

                                <% } %>
    </div>

    <script>
        const btn = document.getElementById('getLocationBtn');
        if (btn) {
            btn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    alert("Geolocation is not supported by your browser");
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Finding nearest shops...';

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    // Add a small delay for effect
                    setTimeout(() => {
                        window.location.href = `/shops?lat=${latitude}&lng=${longitude}&range=5`;
                    }, 800);
                }, (err) => {
                    console.error(err);
                    alert("Unable to retrieve your location. Please check your browser settings or allow location access.");
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i> Detect My Location';
                });
            });
        }

        const slider = document.getElementById('rangeSlider');
        const rangeValue = document.getElementById('rangeValue');
        const applyBtn = document.getElementById('applyRangeBtn');

        if (slider && applyBtn) {
            // Update display value as slider moves
            slider.addEventListener('input', (e) => {
                rangeValue.textContent = e.target.value;
            });

            // Apply filter when button is clicked
            applyBtn.addEventListener('click', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const lat = urlParams.get('lat');
                const lng = urlParams.get('lng');
                const newRange = slider.value;

                if (lat && lng) {
                    // If location is in URL, update range and keep location
                    urlParams.set('range', newRange);
                    window.location.search = urlParams.toString();
                } else {
                    // If no URL location, redirect with just range - backend will use saved user location
                    window.location.href = `/shops?range=${newRange}`;
                }
            });
        }

        // Search Filter
        const searchInput = document.getElementById('shopSearchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function () {
                const filter = this.value.toLowerCase();
                const cards = document.querySelectorAll('.product-card-link');

                cards.forEach(card => {
                    const title = card.querySelector('.prod-title').innerText.toLowerCase();
                    const owner = card.querySelector('.prod-desc').innerText.toLowerCase();
                    const meta = card.querySelector('.prod-meta').innerText.toLowerCase();

                    if (title.includes(filter) || owner.includes(filter) || meta.includes(filter)) {
                        card.style.display = "";
                    } else {
                        card.style.display = "none";
                    }
                });
            });
        }

        // Open Now Switch Logic
        const openNowSwitch = document.getElementById('openNowSwitch');
        if (openNowSwitch) {
            const urlParams = new URLSearchParams(window.location.search);
            openNowSwitch.checked = urlParams.get('openNow') === 'true';

            openNowSwitch.addEventListener('change', (e) => {
                const urlParams = new URLSearchParams(window.location.search);
                if (e.target.checked) {
                    urlParams.set('openNow', 'true');
                } else {
                    urlParams.delete('openNow');
                }
                window.location.search = urlParams.toString();
            });
        }
    </script>