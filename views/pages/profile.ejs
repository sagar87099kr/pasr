<% layout('./layoutes/boilerplate.ejs') -%>
  <script>
    window.mapToken = "<%= mapToken %>";
    window.allData = <% - JSON.stringify(providerData) %>;
    window.EXISTING_DAYS = <% - JSON.stringify(typeof existingDays !== "undefined" ? existingDays : []) %>;
    window.IS_OWNER = <%= (currUser && providerData.owner._id.toString() === currUser._id.toString()) ? 'true' : 'false' %>;
  </script>

  <body>
    <!-- <main class="page"> -->
    <section class="layout">

      <!-- LEFT COLUMN -->
      <div class="col left">

        <!-- PROFILE (height auto, width 600) -->
        <section class="cardin profile-card" id="profileCard">
          <div class="profile-grid">

            <!-- Image 250x375 -->
            <div class="profile-img" id="profileImg" style="position: relative;">
              <img src=<%=providerData.personImage[0].path %>
              alt="Profile"
              />
              <button class="btn-share" id="shareBtn" type="button" title="Share Profile">
                <i class="fa-solid fa-share-nodes"></i>
              </button>
            </div>

            <style>
              .btn-share {
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transition: transform 0.2s, background 0.2s;
                z-index: 10;
                color: #333;
                font-size: 16px;
              }

              .btn-share:hover {
                transform: scale(1.1);
                background: #fff;
                color: #2563eb;
              }
            </style>

            <script>
              document.addEventListener("DOMContentLoaded", () => {
                const shareBtn = document.getElementById('shareBtn');
                if (shareBtn) {
                  shareBtn.addEventListener('click', async () => {
                    if (navigator.share) {
                      try {
                        await navigator.share({
                          title: '<%=providerData.company%>',
                          text: 'Check out this service provider on PaSr!',
                          url: window.location.href
                        });
                      } catch (err) {
                        console.log('Error sharing:', err);
                      }
                    } else {
                      navigator.clipboard.writeText(window.location.href);
                      alert('Profile link copied to clipboard!');
                    }
                  });
                }
              });
            </script>

            <!-- Info -->
            <div class="profile-info" id="profileInfo">
              <h1 class="name" id="pName">
                <%=providerData.company %>
              </h1>
              <div class="service" id="pService">owner:- <%=providerData.owner.name %>
              </div>

              <!-- Contacts (name/address/phone) -->
              <div class="info-grid" id="pContacts">
                <div class="info-item">
                  <span class="label">Address</span>
                  <span class="value" id="pAddress">
                    <%=providerData.location %>
                  </span>
                </div>
                <div class="info-item">
                  <span class="label">Location</span>
                  <span class="value" id="pLocation">India</span>
                </div>
              </div>

              <!-- Contact Action Buttons -->
              <div class="contact-actions" style="margin-top: 12px; display: grid; gap: 10px;">
                <a href="https://wa.me/91<%=providerData.owner.username %>?text=Hi%20<%=encodeURIComponent(providerData.company)%>,%20I%20want%20to%20book%20your%20service"
                  class="btn-action btn-whatsapp" target="_blank"
                  style="background: #25D366; color: white; padding: 12px 16px; border-radius: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; border: 1px solid #1da851; transition: background 0.2s;">
                  <i class="fa-brands fa-whatsapp" style="font-size: 18px;"></i>
                  Book Service on WhatsApp
                </a>
                <a href="tel:+91<%=providerData.owner.username %>" class="btn-action btn-call"
                  style="background: #2563eb; color: white; padding: 12px 16px; border-radius: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; border: 1px solid #1d4ed8; transition: background 0.2s;">
                  <i class="fa-solid fa-phone" style="font-size: 16px;"></i>
                  Call Me
                </a>
              </div>

              <style>
                .btn-whatsapp:hover {
                  background: #1da851 !important;
                }

                .btn-call:hover {
                  background: #1d4ed8 !important;
                }
              </style>
              <div class="actions">
                <%if (currUser && providerData.owner._id.equals(currUser._id)){%>
                  <form action="/provider/<%=providerData._id  %>/edit">
                    <button class="btn primary" id="updateBtn">Update</button>
                  </form>
                  <%}%>

              </div>
              <div class="value">
                serviced:-<%=providerData.experience%> years
              </div>
            </div>

          </div>
        </section>
        <section class="cardin profile-card" id="profileCard">
          <div class="info-item">
            <span class="label">discription</span>
            <span class="value" id="pLocation">
              <%=providerData.discription%>
            </span>
          </div>
        </section>


        <!-- REVIEWS BELOW PROFILE (left) -->
        <section class="cardin reviews-card" id="reviewsSection">
          <div class="head">
            <div>
              <h2>Review & Rating</h2>
              <p class="muted">Submit your rating and review. It will appear below.</p>
            </div>

            <div class="sort">
              <label class="muted small">Sort</label>
              <select id="sortReviews">
                <option value="latest">Latest</option>
                <option value="highest">Highest</option>
                <option value="lowest">Lowest</option>
              </select>
            </div>
          </div>



          <!-- Separate place to create review -->
          <form class="review-form" id="reviewForm" action="/<%= providerData._id %>/reviews" method="POST" novalidate
            class="needs-validation">
            <div class="row">
              <div class="field">
                <label>Rating</label>
                <select id="rRating" required name="review[ratings]">
                  <option value="5">5 - Excellent</option>
                  <option value="4">4 - Good</option>
                  <option value="3">3 - Average</option>
                  <option value="2">2 - Poor</option>
                  <option value="1">1 - Bad</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label>Review</label>
              <textarea id="rText" rows="3" placeholder="Write your review..." required
                name="review[comment]"></textarea>
            </div>

            <div class="form-actions">
              <button class="btn primary">Add review</button>
              <button class="btn ghost danger" type="button" id="clearReviews">Clear</button>
            </div>
          </form>

          <div class="divider"></div>

          <!-- Show reviews -->
          <div class="reviews">
            <div class="reviews-header">
              <h2>Reviews</h2>
              <p class="reviews-subtitle">What people are saying</p>
            </div>

            <div class="reviews-list">
              <% for (let review of providerData.review){%>
                <!-- Review Card -->
                <div class="review-card">
                  <div class="review-top">
                    <div class="review-user">
                      <div class="avatar">RK</div>
                      <div class="user-meta">
                        <div class="user-name">@<%=review.author.name%>
                        </div>
                        <div class="user-sub">Verified customer</div>
                      </div>
                    </div>

                    <!-- Rating (change data-rating="1..5") -->
                    <div class="rating" data-rating="<%=review.ratings%>" aria-label="4 out of 5 stars">
                      <span class="star">★</span>
                      <span class="star">★</span>
                      <span class="star">★</span>
                      <span class="star">★</span>
                      <span class="star">★</span>
                    </div>
                  </div>

                  <p class="review-comment">
                    <%=review.comment%>
                  </p>
                  <form action="/provider/<%=providerData._id%>/review/<%= review._id %>?_method=DELETE" method="POST">
                    <button class="btn btn-sm btn-danger" style="color: red;"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </div>
                <%}%>
            </div>
          </div>


        </section>

      </div>

      <!-- RIGHT COLUMN -->
      <div class="col right">

        <!-- CALENDAR (height auto, width 600) -->
        <!-- views/shedule.ejs (HTML) -->
        <div class="cal-wrap" id="calWrap" data-id="<%= providerData._id %>">
          <div class="cal-topbar">
            <div class="cal-title">
              <div class="cal-h1">Shedule</div>
              <div class="cal-h2" id="monthLabel">—</div>
            </div>

            <div class="cal-nav">
              <button class="btn ghost" id="prevBtn" type="button">◀</button>
              <button class="btn ghost" id="todayBtn" type="button">Current</button>
              <button class="btn ghost" id="nextBtn" type="button">▶</button>
            </div>
          </div>

          <div class="cal-legend">
            <span class="dot free"></span><span>Free</span>
            <span class="dot busy"></span><span>Busy</span>
            <span class="small">Click a day to toggle</span>
          </div>

          <div class="months" id="months"></div>

          <!-- FORM POST to /shedule/:id -->
          <% if (currUser && providerData.owner._id.equals(currUser._id)) { %>
            <form id="scheduleForm" method="POST" action="/shedule/<%= providerData._id %>">
              <input type="hidden" name="daysJson" id="daysJson" value="" />
              <div class="cal-actions">
                <button class="btn primary" id="submitBtn" type="submit">Submit</button>
              </div>
            </form>
            <% } %>
        </div>
        <!-- IMAGE GALLERY below calendar but on RIGHT (replaces map) -->
        <section class="cardin gallery-card" id="gallerySection">
          <div class="head">
            <div>
              <h2>Gallery</h2>
              <p class="muted">Provider images and work samples</p>
            </div>
          </div>

          <!-- Upload Form (Owner Only) -->
          <% if (currUser && providerData.owner._id.equals(currUser._id)) { %>
            <form action="/provider/<%= providerData._id %>/add-image" method="POST" enctype="multipart/form-data"
              class="gallery-upload-form">
              <div class="upload-group">
                <div class="field">
                  <label for="galleryImage">Upload Image</label>
                  <input type="file" id="galleryImage" name="image" accept="image/*" required>
                </div>
                <div class="field">
                  <label for="imageDescription">Description</label>
                  <input type="text" id="imageDescription" name="description" placeholder="Describe this image..."
                    maxlength="200">
                </div>
                <button type="submit" class="btn primary">
                  <i class="fa-solid fa-upload"></i> Add Image
                </button>
              </div>
            </form>
            <div class="divider"></div>
            <% } %>

              <!-- Image Grid -->
              <div class="gallery-grid">
                <% if (providerData.Image && providerData.Image.length> 0) { %>
                  <% providerData.Image.forEach((img, index)=> { %>
                    <div class="gallery-item">
                      <div class="gallery-img-wrap"
                        onclick="openImageModal('<%= img.url %>', '<%= (img.description || '').replace(/'/g, '\\\'') %>', <%= index %>)">
                        <img src="<%= img.url %>" alt="<%= img.description || 'Gallery image' %>">
                      </div>
                      <% if (img.description) { %>
                        <p class="gallery-desc">
                          <%= img.description %>
                        </p>
                        <% } %>
                          <% if (currUser && providerData.owner._id.equals(currUser._id)) { %>
                            <!-- No hidden form needed anymore -->
                            <% } %>
                    </div>
                    <% }) %>
                      <% } else { %>
                        <p class="muted" style="grid-column: 1/-1; text-align: center; padding: 40px 20px;">
                          No images uploaded yet.
                          <% if (currUser && providerData.owner._id.equals(currUser._id)) { %>
                            <br>Upload your first image above!
                            <% } %>
                        </p>
                        <% } %>
              </div>
        </section>

        <!-- Image Modal for Full View -->
        <div id="imageModal" class="image-modal" onclick="closeImageModal()">
          <span class="modal-close">&times;</span>
          <img class="modal-image" id="modalImage" src="" alt="">
          <div class="modal-caption" id="modalCaption"></div>

          <!-- Delete Form in Modal -->
          <div id="modalDeleteBtnContainer" style="display: none; margin-top: 15px;">
            <form id="modalDeleteForm" method="POST"
              onsubmit="return confirm(`Are you sure you want to delete ${this.getAttribute('data-desc') || 'this image'}? This action cannot be undone.`);">
              <button type="submit" class="btn btn-danger">
                <i class="fa-solid fa-trash"></i> Delete Image
              </button>
            </form>
          </div>
        </div>

        <style>
          /* Gallery Upload Form */
          .gallery-upload-form {
            margin-bottom: 20px;
          }

          .upload-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
          }

          .upload-group .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
          }

          .upload-group label {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
          }

          .upload-group input[type="file"],
          .upload-group input[type="text"] {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
          }

          /* Gallery Grid */
          .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
          }

          .gallery-item {
            position: relative;
            background: #f9fafb;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
          }

          .gallery-img-wrap {
            cursor: pointer;
            aspect-ratio: 1;
            overflow: hidden;
            background: #e5e7eb;
          }

          .gallery-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
          }

          .gallery-img-wrap:hover img {
            transform: scale(1.05);
          }

          .gallery-desc {
            padding: 8px 12px;
            font-size: 13px;
            color: #6b7280;
            margin: 0;
            background: white;
          }

          .gallery-delete-form {
            position: absolute;
            top: 8px;
            right: 8px;
            margin: 0;
          }

          .btn-delete-img {
            background: rgba(220, 38, 38, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 10;
          }

          .btn-delete-img:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
          }

          /* Image Modal */
          .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            flex-direction: column;
          }

          .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
          }

          .modal-close:hover {
            color: #bbb;
          }

          .modal-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            animation: zoomIn 0.3s;
          }

          .modal-caption {
            color: #ccc;
            padding: 16px;
            text-align: center;
            font-size: 16px;
            max-width: 80%;
          }

          @keyframes zoomIn {
            from {
              transform: scale(0.8);
              opacity: 0;
            }

            to {
              transform: scale(1);
              opacity: 1;
            }
          }

          /* Responsive */
          @media (max-width: 768px) {
            .gallery-grid {
              grid-template-columns: repeat(3, 1fr);
              gap: 8px;
            }
          }

          @media (max-width: 480px) {
            .gallery-grid {
              grid-template-columns: repeat(3, 1fr);
              gap: 6px;
            }
          }
        </style>

        <script>
          let currentImageIndex = null;
          const isOwner = <%= (currUser && providerData.owner._id.equals(currUser._id)) ? 'true' : 'false' %>;

          function openImageModal(imageUrl, description, index) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const caption = document.getElementById('modalCaption');
            const deleteBtnContainer = document.getElementById('modalDeleteBtnContainer');

            modal.style.display = 'flex';
            modalImg.src = imageUrl;
            caption.textContent = description;

            // Set current index for deletion
            currentImageIndex = index;

            // Show delete button only if owner
            if (isOwner && index !== undefined && index !== null) {
              deleteBtnContainer.style.display = 'block';
              const deleteForm = document.getElementById('modalDeleteForm');
              if (deleteForm) {
                const deleteBaseUrl = "/provider/<%= providerData._id %>/delete-image/";
                deleteForm.action = `${deleteBaseUrl}${index}?_method=DELETE`;
                deleteForm.setAttribute('data-desc', description);
              }
            } else {
              deleteBtnContainer.style.display = 'none';
            }
          }

          function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            currentImageIndex = null;
          }


          // Close modal on Escape key
          document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
              closeImageModal();
            }
          });

          // Override modal click to prevent closing when clicking content
          document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('imageModal');
            if (modal) {
              modal.onclick = function (event) {
                if (event.target === modal) {
                  closeImageModal();
                }
              };
            }
          });
        </script>

      </div>

    </section>
    <!-- </main> -->
    <!-- <script src="/js/script.js"></script> -->
    <script src="/js/profile.js"></script>
  </body>