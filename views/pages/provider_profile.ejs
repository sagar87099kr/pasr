<% layout('./layoutes/boilerplate.ejs') -%>
  <link rel="stylesheet" href="/css/provider_profile.css">

  <body>
    <div class="profile-container">

      <!-- User Profile Card -->
      <section class="profile-card">
        <div class="card-header">
          <div class="user-info">
            <h2>
              <%= currUser.name %>
            </h2>
            <span class="user-type">Customer / Provider Profile</span>
          </div>

          <span class="status-badge <%= currUser.verified %>">
            <span class="status-dot"></span>
            <%= currUser.verified ? 'Verified' : 'Not Verified' %>
          </span>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Contact Number</span>
            <span class="info-value">
              <%= currUser.username %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Email Address</span>
            <span class="info-value">
              <%= currUser.emailAddress %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Current Address</span>
            <span class="info-value">
              <%= currUser.address %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Pincode</span>
            <span class="info-value">
              <%= currUser.pincode %>
            </span>
          </div>
        </div>

        <!-- Update Location Form -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fa-solid fa-map-location-dot"></i> Update Location
          </h3>

          <form action="/customer/update/<%= currUser._id %>?_method=PUT" method="POST">
            <div class="form-group">
              <label for="addressInput" class="form-label">Change Your Location</label>
              <div class="input-group">
                <input type="text" class="form-control" id="addressInput" required name="customer[address]"
                  value="<%= currUser.address%>">
                <button class="btn btn-secondary" type="button" id="getLocationBtn" title="Use Current Location">
                  <i class="fa-solid fa-location-crosshairs"></i>
                </button>
              </div>
              <div class="invalid-feedback">You need to enter your location.</div>
            </div>

            <div class="form-group">
              <label for="exampleInputpincode" class="form-label">Pincode</label>
              <input type="text" class="form-control" id="exampleInputpincode" required name="customer[pincode]"
                value="<%= currUser.pincode%>">
              <div class="invalid-feedback">You need to enter your pincode.</div>
            </div>

            <button class="btn btn-primary" style="width: 100%;">
              Update Location
            </button>
          </form>
        </div>
      </section>

      <!-- Listings Section -->
      <% if (listings && listings.length> 0) { %>
        <section class="profile-card">
          <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
            <div class="user-info">
              <h2>My Listings</h2>
              <span class="user-type">Manage your services</span>
            </div>
          </div>

          <div class="listings-grid">
            <% listings.forEach(listing=> { %>
              <div class="listing-card">
                <div class="listing-info">
                  <img src="<%= listing.personImage[0].path %>" alt="Service Image" class="listing-img">
                  <div class="listing-details">
                    <h4>
                      <%= listing.company %>
                    </h4>
                    <p class="listing-cat">
                      <%= listing.categories %>
                    </p>
                  </div>
                </div>
                <a href="/provider/<%= listing._id %>/profile" class="btn btn-view">
                  View Profile <i class="fa-solid fa-arrow-right"></i>
                </a>
              </div>
              <% }) %>
          </div>
        </section>
        </section>
        <% } %>

          <!-- Products Section -->
          <% if (products && products.length> 0) { %>
            <section class="profile-card">
              <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
                <div class="user-info">
                  <h2>My Products</h2>
                  <span class="user-type">Manage your products</span>
                </div>
              </div>

              <div class="listings-grid">
                <% products.forEach(product=> { %>
                  <div class="listing-card">
                    <div class="listing-info">
                      <img src="<%= product.productImage[0].url %>" alt="Product Image" class="listing-img">
                      <div class="listing-details">
                        <h4>
                          <%= product.productName %>
                        </h4>
                        <p class="listing-cat">
                          <%= product.categories %>
                        </p>
                        <p class="listing-cat" style="color: #6b7280; font-size: 12px;">Qty: <%= product.quantity %>
                        </p>
                      </div>
                    </div>
                    <a href="/products/<%= product._id %>" class="btn btn-view">
                      View Product <i class="fa-solid fa-arrow-right"></i>
                    </a>
                  </div>
                  <% }) %>
              </div>
            </section>
            <% } %>

    </div>

    <script>
      document.getElementById('getLocationBtn').addEventListener('click', () => {
        const btn = document.getElementById('getLocationBtn');
        const input = document.getElementById('addressInput');

        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser");
          return;
        }

        btn.disabled = true;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

        navigator.geolocation.getCurrentPosition(async (position) => {
          const { latitude, longitude } = position.coords;
          try {
            const res = await fetch(`/get-address?lat=${latitude}&lon=${longitude}`);
            const data = await res.json();
            if (data.address) {
              input.value = data.address;
            } else {
              alert("Could not find address for this location.");
            }
          } catch (err) {
            console.error(err);
            alert("Failed to fetch address.");
          } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
          }
        }, (err) => {
          console.error(err);
          alert("Unable to retrieve your location.");
          btn.disabled = false;
          btn.innerHTML = originalContent;
        });
      });
    </script>
  </body>