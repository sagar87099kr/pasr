<% layout('./layoutes/boilerplate.ejs') -%>
  <link rel="stylesheet" href="/css/provider_profile.css">

  <body>
    <div class="profile-container">

      <!-- User Profile Card -->
      <section class="profile-card">
        <div class="card-header">
          <div class="user-info">
            <h2>
              <%= currUser.name %>
            </h2>
            <span class="user-type">Customer / Provider Profile</span>
          </div>

          <span class="status-badge <%= currUser.verified %>">
            <span class="status-dot"></span>
            <%= currUser.verified ? 'Verified' : 'Not Verified' %>
          </span>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Contact Number</span>
            <span class="info-value">
              <%= currUser.username %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Email Address</span>
            <span class="info-value">
              <%= currUser.emailAddress %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Current Address</span>
            <span class="info-value">
              <%= currUser.address %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Pincode</span>
            <span class="info-value">
              <%= currUser.pincode %>
            </span>
          </div>
        </div>

        <!-- Update Location Form -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fa-solid fa-map-location-dot"></i> Update Location
          </h3>

          <form action="/customer/update/<%= currUser._id %>?_method=PUT" method="POST">
            <div class="form-group">
              <label for="addressInput" class="form-label">Change Your Location</label>
              <div class="input-group">
                <input type="text" class="form-control" id="addressInput" required name="customer[address]"
                  value="<%= currUser.address%>">
                <button class="btn btn-secondary" type="button" id="getLocationBtn" title="Use Current Location">
                  <i class="fa-solid fa-location-crosshairs"></i>
                </button>
              </div>
              <div class="invalid-feedback">You need to enter your location.</div>
            </div>

            <div class="form-group">
              <label for="exampleInputpincode" class="form-label">Pincode</label>
              <input type="text" class="form-control" id="exampleInputpincode" required name="customer[pincode]"
                value="<%= currUser.pincode%>">
              <div class="invalid-feedback">You need to enter your pincode.</div>
            </div>

            <button class="btn btn-primary" style="width: 100%;">
              Update Location
            </button>
          </form>
        </div>

        <!-- Delete Account Section -->
        <div class="form-section" style="border-top: 1px solid #e5e7eb; padding-top: 24px; margin-top: 24px;">
          <h3 class="section-title" style="color: #dc2626;">
            <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone
          </h3>
          <p style="color: #6b7280; margin-bottom: 16px;">Deleting your account will permanently remove all your data
            including listings, shops, products, and reviews.</p>
          <button class="btn btn-danger" style="width: 100%; background-color: #dc2626; border-color: #dc2626;"
            data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
            <i class="fa-solid fa-trash"></i> Delete My Account
          </button>
        </div>
      </section>

      <!-- Delete Account Modal -->
      <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header" style="border-bottom: 2px solid #dc2626; background-color: #fee2e2;">
              <h5 class="modal-title" style="color: #dc2626; font-weight: 600;">
                <i class="fa-solid fa-triangle-exclamation"></i> Delete Account Permanently
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" id="modalBody">
              <!-- Warning Step -->
              <div id="warningStep">
                <div
                  style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
                  <h6 style="color: #dc2626; margin-bottom: 12px; font-weight: 600;">
                    ⚠️ This action cannot be undone!
                  </h6>
                  <p style="margin-bottom: 12px; color: #991b1b;">
                    Deleting your account will permanently remove:
                  </p>
                  <ul style="color: #991b1b; margin-bottom: 0; padding-left: 20px;">
                    <li>All your service provider listings</li>
                    <li>All your shops and shop items</li>
                    <li>All your products from local bazaar</li>
                    <li>All your reviews</li>
                    <li>All your uploaded images</li>
                    <li>Your account and profile data</li>
                  </ul>
                </div>

                <p style="font-weight: 500; margin-bottom: 16px;">
                  Are you absolutely sure you want to proceed?
                </p>

                <button type="button" class="btn btn-danger w-100" onclick="showDeleteForm()">
                  <i class="fa-solid fa-check"></i> Yes, I Want to Delete My Account
                </button>
                <button type="button" class="btn btn-secondary w-100 mt-2" data-bs-dismiss="modal">
                  <i class="fa-solid fa-times"></i> Cancel
                </button>
              </div>

              <!-- Form Step (Hidden Initially) -->
              <div id="formStep" style="display: none;">
                <p style="margin-bottom: 20px; color: #374151;">
                  Please verify your identity to proceed with account deletion:
                </p>

                <form action="/customer/delete-account" method="POST" id="deleteForm">
                  <div class="mb-3">
                    <label for="phoneNumber" class="form-label fw-bold">Phone Number</label>
                    <input type="tel" class="form-control" id="phoneNumber" name="username"
                      placeholder="Enter your 10-digit phone number" pattern="[0-9]{10}" maxlength="10" required>
                  </div>

                  <div class="mb-3">
                    <label for="password" class="form-label fw-bold">Password</label>
                    <input type="password" class="form-control" id="password" name="password"
                      placeholder="Enter your password" required>
                  </div>

                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="confirmDelete" required>
                    <label class="form-check-label" for="confirmDelete">
                      I understand this action is permanent and cannot be undone.
                    </label>
                  </div>

                  <button type="submit" class="btn btn-danger w-100" style="padding: 12px;">
                    <i class="fa-solid fa-trash"></i> Permanently Delete My Account
                  </button>
                  <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showWarning()">
                    <i class="fa-solid fa-arrow-left"></i> Go Back
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Listings Section -->
      <% if (listings && listings.length> 0) { %>
        <section class="profile-card">
          <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
            <div class="user-info">
              <h2>My Listings</h2>
              <span class="user-type">Manage your services</span>
            </div>
          </div>

          <div class="listings-grid">
            <% listings.forEach(listing=> { %>
              <div class="listing-card">
                <div class="listing-info">
                  <img src="<%= listing.personImage[0].path %>" alt="Service Image" class="listing-img">
                  <div class="listing-details">
                    <h4>
                      <%= listing.company %>
                    </h4>
                    <p class="listing-cat">
                      <%= listing.categories %>
                    </p>
                  </div>
                </div>
                <a href="/provider/<%= listing._id %>/profile" class="btn btn-view">
                  View Profile <i class="fa-solid fa-arrow-right"></i>
                </a>
              </div>
              <% }) %>
          </div>
        </section>
        </section>
        <% } %>

          <!-- Products Section -->
          <% if (products && products.length> 0) { %>
            <section class="profile-card">
              <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
                <div class="user-info">
                  <h2>My Products</h2>
                  <span class="user-type">Manage your products</span>
                </div>
              </div>

              <div class="listings-grid">
                <% products.forEach(product=> { %>
                  <div class="listing-card">
                    <div class="listing-info">
                      <img src="<%= product.productImage[0].url %>" alt="Product Image" class="listing-img">
                      <div class="listing-details">
                        <h4>
                          <%= product.productName %>
                        </h4>
                        <p class="listing-cat">
                          <%= product.categories %>
                        </p>
                        <p class="listing-cat" style="color: #6b7280; font-size: 12px;">Qty: <%= product.quantity %>
                        </p>
                      </div>
                    </div>
                    <a href="/products/<%= product._id %>" class="btn btn-view">
                      View Product <i class="fa-solid fa-arrow-right"></i>
                    </a>
                  </div>
                  <% }) %>
              </div>
            </section>
            <% } %>

              <!-- Shops Section -->
              <% if (shops && shops.length> 0) { %>
                <section class="profile-card">
                  <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
                    <div class="user-info">
                      <h2>My Shops</h2>
                      <span class="user-type">Manage your shops</span>
                    </div>
                  </div>

                  <div class="listings-grid">
                    <% shops.forEach(shop=> { %>
                      <div class="listing-card">
                        <div class="listing-info">
                          <img src="<%= shop.shopImage[0].url %>" alt="Shop Image" class="listing-img">
                          <div class="listing-details">
                            <h4>
                              <%= shop.shopName %>
                            </h4>
                            <p class="listing-cat">
                              <%= shop.category %>
                            </p>
                            <p class="listing-cat" style="color: #6b7280; font-size: 12px;">
                              <%= shop.location %>
                            </p>
                          </div>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                          <a href="/shops/<%= shop._id %>" class="btn btn-view flex-grow-1">
                            View Shop
                          </a>
                          <a href="/shops/<%= shop._id %>/edit" class="btn btn-secondary flex-grow-0"
                            style="padding: 0.5rem 0.8rem;">
                            <i class="fa-solid fa-pen-to-square"></i>
                          </a>
                        </div>
                      </div>
                      <% }) %>
                  </div>
                </section>
                <% } %>

    </div>

    <script>
      document.getElementById('getLocationBtn').addEventListener('click', () => {
        const btn = document.getElementById('getLocationBtn');
        const input = document.getElementById('addressInput');

        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser");
          return;
        }

        btn.disabled = true;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        };
        navigator.geolocation.getCurrentPosition(async (position) => {
          const { latitude, longitude } = position.coords;
          try {
            const res = await fetch(`/get-address?lat=${latitude}&lon=${longitude}`);
            const data = await res.json();
            if (data.address) {
              input.value = data.address;
            } else {
              alert("Could not find address for this location.");
            }
          } catch (err) {
            console.error(err);
            alert("Failed to fetch address.");
          } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
          }
        }, (err) => {
          console.error(err);
          alert("Unable to retrieve your location.");
          btn.disabled = false;
          btn.innerHTML = originalContent;
        });
      });
    </script>

    <script>
      // Delete account modal functions
      function showDeleteForm() {
        document.getElementById('warningStep').style.display = 'none';
        document.getElementById('formStep').style.display = 'block';
      }

      function showWarning() {
        document.getElementById('formStep').style.display = 'none';
        document.getElementById('warningStep').style.display = 'block';
      }

      // Reset modal when closed
      const deleteModal = document.getElementById('deleteAccountModal');
      if (deleteModal) {
        deleteModal.addEventListener('hidden.bs.modal', function () {
          showWarning();
          const form = document.getElementById('deleteForm');
          if (form) form.reset();
        });
      }
    </script>
  </body>